<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="generator" content="Doxygen 1.8.13"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>PDI: Hands-on</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<script type="text/javascript" src="navtreedata.js"></script>
	<script type="text/javascript" src="navtree.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div>
<header id="titlearea">
	<div id="projectlogo"><a href="index.html"><img alt="Logo" src="logo.png"/></a></div>
	<h1 id="projectname">PDI&nbsp;<span id="projectnumber">0.7.0-pre_date-2020-05-28-12_15</span></h1>
	<h2 id="projectbrief">Data exchange made easy</h2>
</header>
<nav id="tabs"><ul>
	<li><a href="index.html">About</a>
	<li><a href="Concepts.html">Core concepts</a>
	<li><a href="Installation.html">Installation</a>
	<li><a href="First_steps.html">First steps</a>
	<li><a href="PDI_example.html">PDI example</a>
	<li><a href="Hands_on.html">Hands-on</a>
	<li><a href="Plugins.html">Plugins</a>
	<li><a href="modules.html">C API reference</a>
	<li><a href="Specification_tree_ref.html">Specification tree reference</a>
	<li id="gitlab-ribbon"><a href="https://gitlab.maisondelasimulation.fr/pdidev/pdi">Contribute on Gitlab</a></li>
</ul></nav>
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('Hands_on.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Hands-on </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md4"></a>
Environment</h1>
<p>This hands-on has been tested on the <a href="https://groupes.renater.fr/wiki/poincare/">Poincare</a> machine but it should be easy to adapt to another machine.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Poincare machine</h2>
<p>You should load the file <code>/gpfslocal/pub/pdi/training-env.bash</code> in your environment. To do that, you must source it in every shell you open.</p>
<div class="fragment"><div class="line">$  source /gpfslocal/pub/pdi/training-env.bash </div><div class="line">(load) gnu version 7.3.0</div><div class="line">Using gnu compiler to configure openmpi wrappers...</div><div class="line">(load) openmpi version 2.1.3_gnu73</div><div class="line">(load) hdf5 version 1.10.2_gnu73_openmpi2</div><div class="line">(load) PDI version 0.4.0_gnu73_openmpi2</div><div class="line">(load) git version 2.19.1</div><div class="line">(load) cmake version 3.9.4</div><div class="line">PDI training environment loaded!</div><div class="line">$ pdi</div><div class="line">PDI training environment is available!</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Setup</h1>
<p>When PDI is correctly loaded, you can proceed with getting the sources for the hands-on tutorial from <a href="https://gitlab.maisondelasimulation.fr/PDI/PDI_hands-on">gitlab</a>.</p>
<div class="fragment"><div class="line">git clone https://gitlab.maisondelasimulation.fr/PDI/PDI_hands-on.git</div></div><!-- fragment --><p>Setup the compilation by detecting all dependencies (MPI, paraconf, PDI, ...) using cmake: </p><div class="fragment"><div class="line">cd PDI_hands-on</div><div class="line">cmake .</div></div><!-- fragment --><p>Now you're ready to work, <b>good luck</b>!</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Tutorial</h1>
<h2><a class="anchor" id="autotoc_md8"></a>
Ex1. Getting started</h2>
<p>Ex1 is a simple MPI stencil code. There is no output in the code yet, so we can not see its result. Examine the source code, compile it and run it. </p><div class="fragment"><div class="line">make ex1        # compile the code</div><div class="line">llsubmit ex1.sh # run the code</div></div><!-- fragment --><p>Play with and understand the code parameters in ex1.yml</p>
<p>Run the code with 3 MPI processes.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
Ex2. Now with some PDI</h2>
<p>Ex2 is the same code as ex1 with PDI calls added. The PDI test plugin is used to trace PDI calls.</p>
<p>Examine the source code, compile it and run it. </p><div class="fragment"><div class="line">make ex2        # compile the code</div><div class="line">llsubmit ex2.sh # run the code</div></div><!-- fragment --><p>Add the required <code>PDI_share</code> and <code>PDI_reclaim</code> calls to match the output of <code>ex2.out</code>.</p>
<p>Notice that some share/reclaim pairs come one after the other while others are interlaced. Is one better than the other?</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Ex3. HDF5 through PDI</h2>
<p>Let's take the code from ex2 and make it output some HDF5 data. No need to touch the C code here, the PDI yaml file should be enough. We have replaced the PDI test plugin by the Decl'HDF5 plugin.</p>
<p>Examine the yaml, compile the code and run it. </p><div class="fragment"><div class="line">make ex3        # compile the code</div><div class="line">llsubmit ex3.sh # run the code</div></div><!-- fragment --><p>We need to fill 2 sections in the yaml file:</p><ul>
<li>the <code>data</code> section to indicate to PDI the type of the fields that are exposed,</li>
<li>the <code>decl_hdf5</code> for the configuration of the Decl'HDF5 plugin</li>
</ul>
<p>Only dsize is written as of now, let's add <code>psize</code> and <code>pcoord</code> to match the content expected described in <code>ex3.out</code>.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Ex4. Writing some real data</h2>
<p>We keep the same code and touch only the yaml file again.</p>
<p>This time:</p><ul>
<li>we will write the real 2D data contained in <code>main_field</code>,</li>
<li>we will use 2 MPI processes.</li>
</ul>
<p>Notice that we use a list to write multiple files in the decl_hdf5 section instead of a single mapping as before.</p>
<p>Examine the yaml, compile the code and run it. </p><div class="fragment"><div class="line">make ex4        # compile the code</div><div class="line">llsubmit ex4.sh # run the code</div></div><!-- fragment --><p>Unlike the other fields we manipulated until now, the type of <code>main_field</code> is not fully known, its size is dynamic. By moving other fields in the <code>metadata</code> section, we can reference them from "$ expressions" in the configuration file. This can be used to specify a dynamic size for <code>main_field</code>.</p>
<p>Unlike the other fields we manipulated until now, <code>main_field</code> is exposed multiple times. In order not to overwrite it every time it is exposed, we can add a <code>when</code> condition to restrict its output. Only write <code>main_field</code> at the second iteration (when <code>ii==0</code>).</p>
<p>Change the parallelism degree to 2 in height (don't forget to use 2 processes in ex4.sh) and try to match the expected content described in <code>ex4.out</code>.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Ex5. Introducing events</h2>
<p>In ex4, we wrote 2 pieces of data to <code>ex4-data*.h5</code>, but the file is opened and closed for each and every write. Since Decl'HDF5 only sees the data appear one after the other, it does not keep the file open. Since <code>ii</code> and <code>main_field</code> are shared in an interlaced way, they are both available at the same time and could be written without opening the file twice. We have to use events for that.</p>
<p>Examine the yaml and source code, compile and run. </p><div class="fragment"><div class="line">make ex5        # compile the code</div><div class="line">llsubmit ex5.sh # run the code</div></div><!-- fragment --><p>Add a <code>PDI_event</code> call to the code when both <code>ii</code> and <code>main_field</code> are available. With the test plugin, check that the event is indeed triggered at the expected time as described in <code>ex5-trace.out</code>.</p>
<p>Use the <code>on_event</code> mechanism to trigger the write of <code>ii</code> and <code>main_field</code>. This mechanism can be combined with a <code>when</code> directive, in that case the write is only executed when both mechanisms agree.</p>
<p>Also notice the extended syntax that make it possible to write data to a dataset with a name different from the data in PDI. Use this mechanism to write main_field at iterations 1 and 2, in two distinct groups. Match the content as expected in <code>ex5-hdf5.out</code>.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Ex6. Simplifying the code</h2>
<p>As you can notice, the PDI code is quite redundant. In this exercise, we will use <code>PDI_expose</code> and <code>PDI_multi_expose</code> to simplify the code while keeping the exact same behaviour.</p>
<p>Examine the source code, compile it and run it. </p><div class="fragment"><div class="line">make ex6        # compile the code</div><div class="line">llsubmit ex6.sh # run the code</div></div><!-- fragment --><p>There are lots of matched <code>PDI_share</code>/<code>PDI_reclaim</code> in the code. Replace these by <code>PDI_expose</code> that is the exact equivalent of a <code>PDI_share</code> followed by a matching <code>PDI_reclaim</code>.</p>
<p>This replacement is not possible for interlaced <code>PDI_share</code>/<code>PDI_reclaim</code> with events in the middle. This case is however handled by <code>PDI_multi_expose</code> call that exposes all data, then triggers an event and finally does all the reclaim in reverse order. Replace the remaining <code>PDI_share</code>/<code>PDI_reclaim</code> by <code>PDI_expose</code>s and <code>PDI_multi_expose</code>s.</p>
<p>Ensure that your code keeps the exact same behaviour by comparing its trace to <code>ex6.out</code></p>
<h2><a class="anchor" id="autotoc_md14"></a>
Ex7. writing a selection</h2>
<p>In this exercise, we will only write a selection of the data to the HDF5 file.</p>
<p>Examine the yaml, compile the code and run it. </p><div class="fragment"><div class="line">make ex7        # compile the code</div><div class="line">llsubmit ex7.sh # run the code</div></div><!-- fragment --><p>As you can notice, we now independantly describe the dataset in the file. We also use two directives to specify a selection from the data to write and a selection in the dataset where to write.</p>
<p>Restrict the selection to the second line from the data and write it to a one-dimensional dataset in file. Match the expected output described in <code>ex7.out</code>.</p>
<p>You can also add dimensions, write the 2D array excluding ghosts as a slab of a 3D dataset including a dimension for the time-iteration. Write iterations 1 to 3 inclusive into dimensions 0 to 2. Match the expected output described in <code>ex7-bis.out</code>.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Ex8. going parallel</h2>
<p>Running the current code in parallel should already work and yield one file per process containing the local data block. In this exercise we will write one single file with parallel HDF5 whose content should be independent from the number of processes used.</p>
<p>Examine the yaml, compile the code and run it. </p><div class="fragment"><div class="line">make ex8        # compile the code</div><div class="line">llsubmit ex8.sh # run the code</div></div><!-- fragment --><p>We loaded the <code>mpi</code> plugin to make sharing MPI communicators possible.</p>
<p>By uncommenting the <code>communicator</code> directive of the Decl'HDF5 plugin, we can now switch to parallel I/O.</p><ul>
<li>Change the file name so all processes open the same file.</li>
<li>Change the dataset dimension to take the full parallel size into account.</li>
<li>Ensure the dataset selection of each process does not overlap with the others.</li>
<li>Try to match the output from <code>ex8.out</code> that should be independant from the number of processes used.</li>
</ul>
<h1><a class="anchor" id="autotoc_md16"></a>
What next ?</h1>
<p>You can experiment with other <a class="el" href="Plugins.html">plugins</a>. Why not try <a class="el" href="FlowVR_plugin.html">FlowVR</a> for example?</p>
<p>Take a look at the examples in the PDI repository: <code><a href="https://gitlab.maisondelasimulation.fr/jbigot/pdi/tree/0.5/example">https://gitlab.maisondelasimulation.fr/jbigot/pdi/tree/0.5/example</a></code> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</body>
</html>
