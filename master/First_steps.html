<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="generator" content="Doxygen 1.8.13"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>PDI: First steps with PDI</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<script type="text/javascript" src="navtreedata.js"></script>
	<script type="text/javascript" src="navtree.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div>
<header id="titlearea">
	<div id="projectlogo"><a href="index.html"><img alt="Logo" src="logo.png"/></a></div>
	<h1 id="projectname">PDI&nbsp;<span id="projectnumber">0.7.0-pre_date-2020-11-16-11_24</span></h1>
	<h2 id="projectbrief">Data exchange made easy</h2>
</header>
<nav id="tabs"><ul>
	<li><a href="index.html">About</a>
	<li><a href="Installation.html">Installation</a>
	<li><a href="Concepts.html">Core concepts</a>
	<li><a href="First_steps.html">First steps</a>
	<li><a href="Hands_on.html">Tutorial</a>
	<li><a href="PDI_example.html">PDI example</a>
	<li><a href="modules.html">C API reference</a>
	<li><a href="Specification_tree_ref.html">Specification tree reference</a>
	<li><a href="Plugins.html">Plugins</a>
	<li id="gitlab-ribbon"><a href="https://gitlab.maisondelasimulation.fr/pdidev/pdi">Contribute on Gitlab</a></li>
</ul></nav>
<!-- Generated by Doxygen 1.8.13 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('First_steps.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">First steps with PDI </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="Yaml"></a>
Yaml language</h1>
<p>Yaml is used to create the specification tree of PDI. There are 3 basic values in yaml:</p><ol type="1">
<li>Scalar - is a single value.</li>
<li>List - is an array of values.</li>
<li>Map - consist of mulitple keys and values.</li>
</ol>
<p>Indentation level indicates the level in the tree.</p>
<p>Here is an example: </p><div class="fragment"><div class="line">tree_1:</div><div class="line">  array_1:</div><div class="line">    - scalar_1</div><div class="line">    - scalar_2</div><div class="line">  array_2: [1, 2, 3]</div><div class="line">tree_2: {subtree_1: scalar_1, subtree_2: scalar_2}</div></div><!-- fragment --><div class="image">
<img src="yaml_example.jpg" alt="yaml_example.jpg"/>
<div class="caption">
Visualization of the yaml tree.</div></div>
<p>The blue nodes are map values, yellow are lists and pink are scalars. As can be seen, the list and map can be defined in both ways (in one line and multiple lines).</p>
<p>The PDI_init function gets as parameter a tree with <code>logging</code>, <code>data</code>, <code>metadata</code> and <code>plugins</code> maps defined in its root. User can define its own values in yaml and pass to PDI only the subtree:</p>
<div class="fragment"><div class="line">duration: 0.75</div><div class="line">size: [64, 64]</div><div class="line">parallelism: { height: 4, width: 4 }</div><div class="line"></div><div class="line"># only the following config will be passed to PDI</div><div class="line">pdi_subtree:</div><div class="line">  metadata:</div><div class="line">    iteration: int</div><div class="line">  data:</div><div class="line">    main_field: double</div><div class="line">  plugins:</div><div class="line">    decl_hdf5:</div><div class="line">       ...</div></div><!-- fragment --><p>C source code: </p><div class="fragment"><div class="line">PC_tree_t root = PC_parse_path(<span class="stringliteral">&quot;example.yaml&quot;</span>);</div><div class="line"><a class="code" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0">PDI_init</a>(PC_get(root, <span class="stringliteral">&quot;pdi_subtree&quot;</span>));</div></div><!-- fragment --><p>Fortran source code: </p><div class="fragment"><div class="line"><span class="keywordtype">type</span>(pc_tree_t),<span class="keywordtype">target</span> :: root</div><div class="line"></div><div class="line"><span class="keyword">call </span>pc_parse_path(<span class="stringliteral">&quot;example.yaml&quot;</span>, root)</div><div class="line"><span class="keyword">call </span>pdi_init(pc_get(root, <span class="stringliteral">&quot;pdi_subtree&quot;</span>))</div></div><!-- fragment --><h1><a class="anchor" id="fs_hello_event"></a>
Hello Event</h1>
<p>As mentioned in <a class="el" href="Concepts.html#Specification_tree">Specification tree</a> we have to provide specification tree to instruct PDI what data we will share and what to do with it. We want to show what happens on each PDI API call. We will use <a class="el" href="trace_plugin.html">Trace plugin</a>, which is very simple plugin that just prints every information it gets. Let's create a specification tree named <code>hello_event.yml</code> that will load trace plugin: </p><div class="fragment"><div class="line">plugins:</div><div class="line">  trace: ~</div></div><!-- fragment --><p>Yes, that is whole specification tree. Trace plugin prints everything, so there is no need to specify what we want it to do.</p>
<p>C source code: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pdi.h&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line">    <a class="code" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0">PDI_init</a>(PC_parse_path(<span class="stringliteral">&quot;hello_event.yml&quot;</span>));</div><div class="line"></div><div class="line">    <a class="code" href="group__annotation.html#gab21d59fd8d6532f6b8d7a4ac69a2388b">PDI_event</a>(<span class="stringliteral">&quot;Hello World Event&quot;</span>);</div><div class="line"></div><div class="line">    <a class="code" href="group__init__final.html#ga7995fbda2099950ed4ffc7fd4c0bb969">PDI_finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Fortran source code: </p><div class="fragment"><div class="line"><span class="keyword">program</span> event</div><div class="line">    <span class="keywordtype">use </span>paraconf</div><div class="line">    <span class="keywordtype">use </span>pdi</div><div class="line">    <span class="keywordtype">implicit none</span></div><div class="line"></div><div class="line">    <span class="keywordtype">type</span>(pc_tree_t),<span class="keywordtype">target</span> :: conf</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pc_parse_path(<span class="stringliteral">&quot;hello_event.yml&quot;</span>, conf)</div><div class="line">    <span class="keyword">call </span>pdi_init(conf)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_event(<span class="stringliteral">&quot;Hello World Event&quot;</span>)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_finalize()</div><div class="line"></div><div class="line"><span class="keyword">end program </span>event</div></div><!-- fragment --><p>Let's analyze what happens in each line. Firstly we have <a class="el" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0" title="Initializes PDI. ">PDI_init()</a> function which take parameter of type <code>PC_tree_t</code>. It's a tree structure parsed from some YAML file, in our case we parse it with <code>paraconf</code> library build in PDI. To parse a file we need to call <code>PC_parse_path</code> function passing file path as argument. The next step is to call an event in PDI named "Hello World Event". At the end we have to call <a class="el" href="group__init__final.html#ga7995fbda2099950ed4ffc7fd4c0bb969" title="Finalizes PDI. ">PDI_finalize()</a>. The output from this program is presented below: </p><div class="fragment"><div class="line">[PDI][Trace-plugin][10:25:28] *** info: Welcome!</div><div class="line">[PDI][10:25:28] *** info: Initialization successful</div><div class="line">[PDI][Trace-plugin][10:25:28] *** info: !!! named event: Hello World Event</div><div class="line">[PDI][10:25:28] *** info: Finalization</div><div class="line">[PDI][Trace-plugin][10:25:28] *** info: Goodbye!</div></div><!-- fragment --><p> The first line indicates that plugin has loaded successfully. The second is PDI message, that tells it managed to create all descriptors and load all defined plugins. Then we have message from loaded trace plugin which printed the event name it has received. The next information is from PDI and indicates that finalization has started and now it will deallocate resources. Last message is from trace plugin destructor.</p>
<h2><a class="anchor" id="fs_hello_data"></a>
Hello Data</h2>
<p>In <a class="el" href="First_steps.html#fs_hello_event">Hello Event</a> we learned how to call an event. In this chapter we will see how to share and reclaim data.</p>
<p>Firstly we have to create a specification tree named <code>hello_data.yml</code> with <code>data</code> and trace plugin tree declared:</p>
<div class="fragment"><div class="line">data:</div><div class="line">  world: int</div><div class="line">plugins:</div><div class="line">  trace: ~</div></div><!-- fragment --><p>We have declared trace plugin and one descriptor named <code>world</code> of integer type.</p>
<p>C source code: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pdi.h&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line">    <a class="code" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0">PDI_init</a>(PC_parse_path(<span class="stringliteral">&quot;hello_data.yml&quot;</span>));</div><div class="line">    <span class="keywordtype">int</span> my_world = 42;</div><div class="line">    <a class="code" href="group__annotation.html#ga34e34cede8627c47c07e6ede997e37fe">PDI_share</a>(<span class="stringliteral">&quot;world&quot;</span>, &amp;my_world, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>);</div><div class="line">    <span class="comment">//variable my_world is shared with PDI</span></div><div class="line"></div><div class="line">    <a class="code" href="group__annotation.html#gabf58b7c146cbf7e3341245f60cec0f7e">PDI_reclaim</a>(<span class="stringliteral">&quot;world&quot;</span>);</div><div class="line">    <span class="comment">//variable my_world is no longer shared with PDI</span></div><div class="line"></div><div class="line">    <a class="code" href="group__init__final.html#ga7995fbda2099950ed4ffc7fd4c0bb969">PDI_finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Fortran source code: </p><div class="fragment"><div class="line"><span class="keyword">program</span> data</div><div class="line">    <span class="keywordtype">use </span>paraconf</div><div class="line">    <span class="keywordtype">use </span>pdi</div><div class="line">    <span class="keywordtype">implicit none</span></div><div class="line"></div><div class="line">    <span class="keywordtype">type</span>(pc_tree_t),<span class="keywordtype">target</span> :: conf</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>        :: my_world</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">pointer</span>       :: p_my_world</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pc_parse_path(<span class="stringliteral">&quot;hello_data.yml&quot;</span>, conf)</div><div class="line">    <span class="keyword">call </span>pdi_init(conf)</div><div class="line"></div><div class="line">    my_world = 42</div><div class="line">    p_my_world =&gt; my_world</div><div class="line">    <span class="keyword">call </span>pdi_share(<span class="stringliteral">&quot;world&quot;</span>, p_my_world, pdi_out)</div><div class="line">    //variable my_world is shared with pdi</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_reclaim(<span class="stringliteral">&quot;world&quot;</span>);</div><div class="line">    //variable my_world is no longer shared with pdi</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_finalize()</div><div class="line"></div><div class="line"><span class="keyword">end program </span>data</div></div><!-- fragment --><p>Let's analyze new functions:</p><ul>
<li><code>PDI_share</code> shares access to the variable with PDI. The first argument is a descriptor name and indicates what data we are sharing. The second one is pointer to our variable and the last one is access direction. <code>PDI_OUT</code> means data direction from application to PDI, <code>PDI_IN</code> is a direction from PDI to the program, <code>PDI_INOUT</code> includes both directions.</li>
<li><code>PDI_reclaim</code> reclaims the share which means that PDI will no longer have access to shared variable. As an argument it takes name of the descriptor.</li>
</ul>
<p>The output from our application: </p><div class="fragment"><div class="line">[PDI][Trace-plugin][10:59:35] *** info: Welcome!</div><div class="line">[PDI][10:59:35] *** info: Initialization successful</div><div class="line">[PDI][Trace-plugin][10:59:35] *** info: =&gt;&gt;   data becoming available in the store: world</div><div class="line">[PDI][Trace-plugin][10:59:35] *** info: &lt;&lt;= data stop being available in the store: world</div><div class="line">[PDI][10:59:35] *** info: Finalization</div><div class="line">[PDI][Trace-plugin][10:59:35] *** info: Goodbye!</div></div><!-- fragment --><p>As we can see from the logs above, when we called <code>PDI_share</code> plugin gained access to the shared variable and after <code>PDI_reclaim</code> the variable has become no longer available for the plugin. The share notification gives plugin possibility to operate on data dependently what has been declared in specification tree.</p>
<p>The same exact result we can achieve with <code>PDI_expose</code> which is just <code>PDI_share</code> call and right after <code>PDI_reclaim</code> is called.</p>
<p>C source code: </p><div class="fragment"><div class="line"><a class="code" href="group__annotation.html#ga34e34cede8627c47c07e6ede997e37fe">PDI_share</a>(<span class="stringliteral">&quot;world&quot;</span>, &amp;my_world, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>);</div><div class="line"><a class="code" href="group__annotation.html#gabf58b7c146cbf7e3341245f60cec0f7e">PDI_reclaim</a>(<span class="stringliteral">&quot;world&quot;</span>);</div></div><!-- fragment --><p>is the same as: </p><div class="fragment"><div class="line"><a class="code" href="group__hl__annotation.html#gabf3f81774644eff9a3cf511e57273454">PDI_expose</a>(<span class="stringliteral">&quot;world&quot;</span>, &amp;my_world, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>);</div></div><!-- fragment --><p>Fortran source code: </p><div class="fragment"><div class="line"><span class="comment">call PDI_share(&quot;world&quot;, p_my_world, PDI_OUT)</span></div><div class="line"><span class="comment">call PDI_reclaim(&quot;world&quot;);</span></div></div><!-- fragment --><p> is the same as: </p><div class="fragment"><div class="line"><span class="comment">call PDI_expose(&quot;world&quot;, p_my_world, PDI_OUT)</span></div></div><!-- fragment --><h2><a class="anchor" id="fs_access"></a>
Hello Access</h2>
<p>Now we will try to access a descriptor we share with PDI. In this case we won't need any plugin. We want to define int and a string in our <code>world_access.yml</code>: </p><div class="fragment"><div class="line">data:</div><div class="line">  my_value: int</div><div class="line">  my_message: {type: array, subtype: char, size: 32}</div></div><!-- fragment --><p>C source code: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pdi.h&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> print_secret_msg() {</div><div class="line">    <span class="keywordtype">int</span>* value;</div><div class="line">    <a class="code" href="group__annotation.html#ga8dcd0c81d7697ea473a55bd57efb717d">PDI_access</a>(<span class="stringliteral">&quot;my_value&quot;</span>, (<span class="keywordtype">void</span>**)&amp;value, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a70fa3cd94e02b997794d9eaaea34b0b6">PDI_IN</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;%d\n&quot;</span>, *value);</div><div class="line">    <a class="code" href="group__annotation.html#ga001117ae897dd4e4a25c312b5d00c43a">PDI_release</a>(<span class="stringliteral">&quot;my_value&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span>* message;</div><div class="line">    <a class="code" href="group__annotation.html#ga8dcd0c81d7697ea473a55bd57efb717d">PDI_access</a>(<span class="stringliteral">&quot;my_message&quot;</span>, (<span class="keywordtype">void</span>**)&amp;message, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a70fa3cd94e02b997794d9eaaea34b0b6">PDI_IN</a>);</div><div class="line">    printf(<span class="stringliteral">&quot;%s\n&quot;</span>, message);</div><div class="line">    <a class="code" href="group__annotation.html#ga001117ae897dd4e4a25c312b5d00c43a">PDI_release</a>(<span class="stringliteral">&quot;my_message&quot;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line">    <a class="code" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0">PDI_init</a>(PC_parse_path(<span class="stringliteral">&quot;world_access.yml&quot;</span>));</div><div class="line">    <span class="keywordtype">int</span> my_value = 42;</div><div class="line">    <a class="code" href="group__annotation.html#ga34e34cede8627c47c07e6ede997e37fe">PDI_share</a>(<span class="stringliteral">&quot;my_value&quot;</span>, &amp;my_value, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>);</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span>* secret_msg = <span class="stringliteral">&quot;Watermelon is the tastiest fruit&quot;</span>;</div><div class="line">    <a class="code" href="group__annotation.html#ga34e34cede8627c47c07e6ede997e37fe">PDI_share</a>(<span class="stringliteral">&quot;my_message&quot;</span>, secret_msg, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>);</div><div class="line"></div><div class="line">    print_secret_msg();</div><div class="line"></div><div class="line">    <a class="code" href="group__annotation.html#gabf58b7c146cbf7e3341245f60cec0f7e">PDI_reclaim</a>(<span class="stringliteral">&quot;my_message&quot;</span>);</div><div class="line">    <a class="code" href="group__annotation.html#gabf58b7c146cbf7e3341245f60cec0f7e">PDI_reclaim</a>(<span class="stringliteral">&quot;my_value&quot;</span>);</div><div class="line"></div><div class="line">    <a class="code" href="group__init__final.html#ga7995fbda2099950ed4ffc7fd4c0bb969">PDI_finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>Fortran source code: </p><div class="fragment"><div class="line"><span class="keyword">subroutine </span>print_secret_msg</div><div class="line">    <span class="keywordtype">use </span>iso_c_binding<span class="keywordtype">, only</span>: c_ptr, c_f_pointer</div><div class="line"></div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">pointer</span>       :: p_value</div><div class="line">    <span class="keywordtype">type</span>(c_ptr)            :: p_value_accessed</div><div class="line">    <span class="keywordtype">character</span>, <span class="keywordtype">pointer</span>     :: p_message(:)</div><div class="line">    <span class="keywordtype">type</span>(c_ptr)            :: p_message_accessed</div><div class="line">    <span class="keywordtype">integer</span>                :: p_message_ranks(1)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_access(<span class="stringliteral">&quot;my_value&quot;</span>, p_value_accessed, pdi_in)</div><div class="line">    c_f_pointer(p_value_accessed, p_value)</div><div class="line">    print *, p_value</div><div class="line">    <span class="keyword">call </span>pdi_release(<span class="stringliteral">&quot;my_value&quot;</span>)</div><div class="line"></div><div class="line">    <span class="comment">! In case of accessing arrays, PDI_access takes additional array argument with dimensions sizes</span></div><div class="line">    p_message_ranks(1) = 512</div><div class="line">    <span class="keyword">call </span>pdi_access(<span class="stringliteral">&quot;my_message&quot;</span>, p_message_accessed, pdi_in, p_message_ranks)</div><div class="line">    c_f_pointer(p_message_accessed, p_message, 512)</div><div class="line">    print *, p_message</div><div class="line">    <span class="keyword">call </span>pdi_release(<span class="stringliteral">&quot;my_message&quot;</span>)</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span></div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">program</span> access</div><div class="line">    <span class="keywordtype">use </span>paraconf</div><div class="line">    <span class="keywordtype">use </span>pdi</div><div class="line">    <span class="keywordtype">implicit none</span></div><div class="line"></div><div class="line">    <span class="keywordtype">type</span>(pc_tree_t),<span class="keywordtype">target</span> :: conf</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>        :: my_value</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">pointer</span>       :: p_my_value</div><div class="line">    <span class="keywordtype">character</span>, <span class="keywordtype">target</span>      :: secret_msg(512)</div><div class="line">    <span class="keywordtype">character</span>, <span class="keywordtype">pointer</span>     :: p_secret_msg(:)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pc_parse_path(<span class="stringliteral">&quot;world_access.yml&quot;</span>, conf)</div><div class="line">    <span class="keyword">call </span>pdi_init(conf)</div><div class="line"></div><div class="line">    my_value = 42</div><div class="line">    p_my_value = my_value</div><div class="line">    <span class="keyword">call </span>pdi_share(<span class="stringliteral">&quot;my_value&quot;</span>, p_my_value, pdi_out)</div><div class="line"></div><div class="line">    secret_msg = <span class="stringliteral">&quot;Watermelon is the tastiest fruit&quot;</span></div><div class="line">    p_secret_msg =&gt; secret_msg</div><div class="line">    <span class="keyword">call </span>pdi_share(<span class="stringliteral">&quot;my_message&quot;</span>, p_secret_msg, pdi_out)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>print_secret_msg();</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_reclaim(<span class="stringliteral">&quot;my_message&quot;</span>);</div><div class="line">    <span class="keyword">call </span>pdi_reclaim(<span class="stringliteral">&quot;my_value&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_finalize()</div><div class="line"></div><div class="line"><span class="keyword">end program </span>access</div></div><!-- fragment --><p>We will focus on <code>print_secret_msg</code> function. If you don't understand what happens in <code>main</code> function, please see <a class="el" href="First_steps.html#fs_hello_data">Hello Data</a> example. <code>PDI_access</code> sets our pointer to the data location. We need to pass <code>PDI_IN</code> because data flows from PDI to our application. We also want to use <code>PDI_release</code>, because <code>PDI_reclaim</code> would end the sharing status of this descriptor and we reclaim this data later in <code>main</code> function. Output from the program:</p>
<div class="fragment"><div class="line">[PDI][13:42:31] *** info: Initialization successful</div><div class="line">Watermelon is the tastiest fruit</div><div class="line">[PDI][13:42:31] *** info: Finalization</div></div><!-- fragment --><p>As you can see, we manage to access data descriptor from function only by passing its name and correct direction access.</p>
<h2><a class="anchor" id="fs_multiexpose"></a>
Hello multi expose</h2>
<p>In some cases we would want to expose many descriptors at once. For this we have multi expose which shares all the given descriptors, then call given event and then reclaim all passed data. Let's look at the example.</p>
<div class="fragment"><div class="line">data:</div><div class="line">  my_int: int</div><div class="line">  my_float: float</div><div class="line">  my_string: {type: array, subtype: char, size: 32}</div><div class="line"></div><div class="line">plugin:</div><div class="line">  trace: ~</div></div><!-- fragment --><p>We have defined 3 descriptors and trace plugin.</p>
<p>C source code: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;pdi.h&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) {</div><div class="line">    <a class="code" href="group__init__final.html#ga3dc660be40c93c169337e3d2692b2ed0">PDI_init</a>(PC_parse_path(<span class="stringliteral">&quot;hello_multi_expose.yml&quot;</span>));</div><div class="line">    <span class="keywordtype">int</span> x = 0;</div><div class="line">    <span class="keywordtype">float</span> y = 0;</div><div class="line">    <span class="keywordtype">char</span>* z = <span class="stringliteral">&quot;RGB = Really Gawky Biscuit&quot;</span>;</div><div class="line"></div><div class="line">    <a class="code" href="group__hl__annotation.html#gae5c670b378e423e3083122f62c1f0a59">PDI_multi_expose</a>(<span class="stringliteral">&quot;event_between&quot;</span>, </div><div class="line">                     <span class="stringliteral">&quot;my_int&quot;</span>, &amp;x, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>,</div><div class="line">                     <span class="stringliteral">&quot;my_float&quot;</span>, &amp;y, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>,</div><div class="line">                     <span class="stringliteral">&quot;my_string&quot;</span>, &amp;z, <a class="code" href="group__annotation.html#gga7c857647f7a8077648c28db634eeb805a49ed5399cbc2fca8085867ea04d01b6e">PDI_OUT</a>,</div><div class="line">                     NULL);</div><div class="line"></div><div class="line">    <a class="code" href="group__init__final.html#ga7995fbda2099950ed4ffc7fd4c0bb969">PDI_finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>First argument of the <code>PDI_multi_expose</code> is the event name we want to call when all the descriptors are shared. After this we pass in loop:</p>
<ul>
<li>name of the descriptor</li>
<li>pointer to the data</li>
<li>direction access As the last argument we have to pass <code>NULL</code>.</li>
</ul>
<p>Fortran source code (have to use transaction): </p><div class="fragment"><div class="line"><span class="keyword">program</span> transaction</div><div class="line">    <span class="keywordtype">use </span>paraconf</div><div class="line">    <span class="keywordtype">use </span>pdi</div><div class="line">    <span class="keywordtype">implicit none</span></div><div class="line"></div><div class="line">    <span class="keywordtype">type</span>(pc_tree_t),<span class="keywordtype">target</span> :: conf</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">target</span>        :: my_int</div><div class="line">    float, <span class="keywordtype">target</span>          :: my_float</div><div class="line">    <span class="keywordtype">character</span>, <span class="keywordtype">target</span>      :: my_string(32)</div><div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">pointer</span>       :: p_my_int</div><div class="line">    float, <span class="keywordtype">pointer</span>         :: p_my_float</div><div class="line">    string, <span class="keywordtype">pointer</span>        :: p_my_string(:)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pc_parse_path(<span class="stringliteral">&quot;hello_transaction.yml&quot;</span>, conf)</div><div class="line">    <span class="keyword">call </span>pdi_init(conf)</div><div class="line"></div><div class="line">    my_int = 0</div><div class="line">    p_my_int =&gt; my_int</div><div class="line"></div><div class="line">    my_float = 0</div><div class="line">    p_my_float =&gt; my_float</div><div class="line"></div><div class="line">    my_string = <span class="stringliteral">&quot;RGB = Really Gawky Biscuit&quot;</span>;</div><div class="line">    p_my_string =&gt; my_string</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_transaction_begin(<span class="stringliteral">&quot;event_between&quot;</span>)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_expose(<span class="stringliteral">&quot;my_int&quot;</span>, p_my_int, pdi_out)</div><div class="line">    <span class="keyword">call </span>pdi_expose(<span class="stringliteral">&quot;my_float&quot;</span>, p_my_float, pdi_out)</div><div class="line">    <span class="keyword">call </span>pdi_expose(<span class="stringliteral">&quot;my_string&quot;</span>, p_my_string, pdi_out)</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_transaction_end()</div><div class="line"></div><div class="line">    <span class="keyword">call </span>pdi_finalize()</div><div class="line"></div><div class="line"><span class="keyword">end program </span>transaction</div></div><!-- fragment --><p>The output of the execution:</p>
<div class="fragment"><div class="line">[PDI][Trace-plugin][14:14:51] *** info: Welcome!</div><div class="line">[PDI][14:14:51] *** info: Initialization successful</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: =&gt;&gt;   data becoming available in the store: my_int</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: =&gt;&gt;   data becoming available in the store: my_float</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: =&gt;&gt;   data becoming available in the store: my_string</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: !!!                            named event: event_between</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: &lt;&lt;= data stop being available in the store: my_string</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: &lt;&lt;= data stop being available in the store: my_float</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: &lt;&lt;= data stop being available in the store: my_int</div><div class="line">[PDI][14:14:51] *** info: Finalization</div><div class="line">[PDI][Trace-plugin][14:14:51] *** info: Goodbye!</div></div><!-- fragment --><p>The logs from trace plugin confirm the execution order we were expecting. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
</body>
</html>
